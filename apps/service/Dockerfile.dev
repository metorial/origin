FROM oven/bun:1

# Install curl for health checks
RUN apt-get update && \
    apt-get install -y curl && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy package files
COPY service/package.json service/bun.lock* ./

# Install all dependencies (including devDependencies)
RUN bun install --frozen-lockfile

# Copy code-bucket workspace files (for @metorial/code-bucket-service-generated)
RUN mkdir -p ./node_modules/@metorial/code-bucket-service-generated
COPY code-bucket/package.json ./node_modules/@metorial/code-bucket-service-generated/
COPY code-bucket/index.ts ./node_modules/@metorial/code-bucket-service-generated/
COPY code-bucket/ts-proto-gen ./node_modules/@metorial/code-bucket-service-generated/ts-proto-gen

# Copy Prisma schema
COPY service/prisma ./prisma
COPY service/prisma.config.ts ./prisma.config.ts

# Generate Prisma client
RUN bun prisma generate

# Health check using curl
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:52090/ping || exit 1

# Start command with hot reloading using --watch
CMD ["sh", "-c", "bun prisma db push --accept-data-loss && bun --watch src/server.ts"]
